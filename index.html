<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Overcalc</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">
</head>
<body>
<div class="container">
    <div class="row justify-content-md-center">
        <div class="col-lg-6 col-sm-12 col-md-10">
            <h1 class="pt-3">–°–µ–∑–æ–Ω 2</h1>
            <form>
                <div class="row">
                    <div class="col-md-6 col-sm-12">
                        <label>–î–æ –∫–æ–Ω—Ü–∞ –∏–≥—Ä–æ–≤–æ–≥–æ –¥–Ω—è:</label>
                        <div class="form-control-plaintext form-control-lg" id="timeRemaining"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3 col-sm-6">
                        <label>–î–Ω–µ–π –æ—Å—Ç–∞–ª–æ—Å—å:</label>
                        <div class="form-control-plaintext form-control-lg" id="daysRemaining"></div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <label>–¶–µ–ª—å —Å–µ–≥–æ–¥–Ω—è:</label>
                        <div class="form-control-plaintext form-control-lg" id="todayStats"></div>
                    </div>
                    <div class="col-md-6 col-sm-12">
                        <label>–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å:</label>
                        <div class="mb-3 d-flex flex-row">
                            <div class="input-group me-2">
                                <button class="btn btn-outline-secondary" type="button" id="unlockEdit"><i id="lockIcon"
                                                                                                           class="bi bi-lock-fill"></i>
                                </button>
                                <input class="form-control form-control-lg" id="currentLevel" type="number"
                                       placeholder="–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å" value="0" disabled>
                            </div>
                            <button id="decrementCurrentLevel" class="btn btn-outline-primary" type="button"><i
                                    class="bi bi-dash-lg"></i></button>
                            <button id="incrementCurrentLevel" class="btn btn-outline-primary ms-2" type="button"><i
                                    class="bi bi-plus-lg"></i></button>
                        </div>
                    </div>

                </div>

            </form>
            <div class="d-flex flex-row">
                    <img id="chatImage" class="me-2 rounded-circle" style="height: 64px;" src="https://cdn.vox-cdn.com/thumbor/FlxmTAdIEj_6gDY0SJVt2z4hNFI=/1400x1400/filters:format(jpeg)/cdn.vox-cdn.com/uploads/chorus_asset/file/19369848/9b85a23a428bced3269b3e193faaaddb.jpg" alt="–ú–µ—Ä—Å–∏">
                    <p class="form-control mb-0"><span id="chatText" class="lead">–ë–ª–∞–∂–µ–Ω–Ω—ã–µ –º–∏–Ω—É—Ç—ã –æ—Ç–¥—ã—Ö–∞. –£–≤—ã, –Ω–∏—á—Ç–æ –Ω–µ –¥–ª–∏—Ç—Å—è –≤–µ—á–Ω–æ.</span></p>
            </div>
            <div class="row pt-3">
                <div>
                    <h2>–î–Ω–∏ —Ñ–∞—Ä–º–∞</h2>
                    <table class="table table-striped">
                        <thead>
                        <tr>
                            <th scope="col">–î–µ–Ω—å</th>
                            <th scope="col">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</th>
                            <th scope="col">–û–ø—Ç. —É—Ä–æ–≤–µ–Ω—å</th>
                        </tr>
                        </thead>
                        <tbody id="daysList">
                        </tbody>
                    </table>
                </div>
            </div>
            
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.6.1.min.js"
        integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>

<script>
    class Event {
        constructor(name, dateStart, dateEnd, emoji) {
            this.name = name;
            this.dateStart = new Date(dateStart);
            this.dateEnd = new Date(dateEnd);
            this.emoji = emoji;
        }
    }

    class ChatMessage {
        constructor(text, rank) {
            this.text = text;
            this.rank = rank;
            this.file = rank + '.webp';
        }
    }

    // –û—Å–Ω–æ–≤—ã–Ω–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    const battlePassStartLvl = 1;
    const battlePassEndLvl = 200;
    const battlePassStartDate = new Date('2022-12-06T19:00:00.000+00:00');
    const battlePassEndDate = new Date('2023-02-07T19:00:00.000+00:00');
    const battlePassDuration = getDateDiff(battlePassEndDate, battlePassStartDate);
    const lvlsForDay = (battlePassEndLvl - battlePassStartLvl) / battlePassDuration;

    // –°–µ–ª–µ–∫—Ç–æ—Ä—ã
    const displayDaysRemaining = $('#daysRemaining');
    const displayTable = $('#daysList');
    const displayTodayStats = $('#todayStats');
    const inputCurrentLvl = $('#currentLevel');
    const decrementButton = $('#decrementCurrentLevel');
    const incrementButton = $('#incrementCurrentLevel');

    // –°–æ–±—ã—Ç–∏—è
    const winterWonderland = new Event("–ó–∏–º–Ω—è—è –°–∫–∞–∑–∫–∞", "12/14/2022", "01/05/2023", "‚ùÑ");
    const BattleForOlympus = new Event("–ë–∏—Ç–≤–∞ –∑–∞ –û–ª–∏–º–ø", "01/06/2023", "01/20/2023", "üèÜ");
    const LunarNewYear = new Event("–õ—É–Ω–Ω—ã–π –ù–æ–≤—ã–π –ì–æ–¥", "01/18/2023", "02/07/2023", "üê∞");
    const events = [winterWonderland, BattleForOlympus, LunarNewYear];

    // –ß–∞—Ç
    const chatMessages = [
        new ChatMessage('–£–≤—ã, —Ç–∞–∫–∏—Ö —Å–æ–æ—Ä—É–∂–µ–Ω–∏–π –±–æ–ª—å—à–µ –Ω–µ —Å—Ç—Ä–æ—è—Ç.', 'p15'),
        new ChatMessage('–¶–µ–Ω–∏—Ç–µ —ç—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –º–≥–Ω–æ–≤–µ–Ω–∏—è —Ç–∏—à–∏–Ω—ã!', 'p13'),
        new ChatMessage('–ò–∑—É–º–∏—Ç–µ–ª—å–Ω–æ!', 'p10'),
        new ChatMessage('–í–ø–µ—á–∞—Ç–ª—è–µ—Ç.', 'p9'),
        new ChatMessage('–¢–µ–±—è –≤—ã–ø–∏—Å–∞–ª–∏.', 'p8'),
        new ChatMessage('–ë–ª–∞–∂–µ–Ω–Ω—ã–µ –º–∏–Ω—É—Ç—ã –æ—Ç–¥—ã—Ö–∞. –£–≤—ã, –Ω–∏—á—Ç–æ –Ω–µ –¥–ª–∏—Ç—Å—è –≤–µ—á–Ω–æ.', 'p7'),
        new ChatMessage('–°—á–µ—Ç –∑–∞ –ø—Ä–∏–µ–º —è –≤—ã—à–ª—é –ø–æ–∑–∂–µ.', 'p6'),
        new ChatMessage('–¢–∞–∫-—Ç–æ –ª—É—á—à–µ.', 'p5'),
        new ChatMessage('–î—Ä—É–≥–æ–µ –¥–µ–ª–æ!', 'p4'),
        new ChatMessage('–¢–∞–∫ –≥–æ—Ä–∞–∑–¥–æ –ª—É—á—à–µ.', 'p3'),
        new ChatMessage('–ì–µ—Ä–æ–∏ –Ω–µ —É–º–∏—Ä–∞—é—Ç!', 'p2'),
        new ChatMessage('–£–∂–µ –Ω–∏—á–µ–≥–æ –Ω–µ –±–æ–ª–∏—Ç?', 'p1'),
        new ChatMessage('–Ø –ø—Ä–∏—Å–º–æ—Ç—Ä—é –∑–∞ —Ç–æ–±–æ–π!', 'p0'),
        new ChatMessage('–î–æ–∫—Ç–æ—Ä–∞ –≤—ã–∑—ã–≤–∞–ª–∏?', 'm1'),
        new ChatMessage('–í—Ä–∞—á–∞! –û–π, —è –∏ –µ—Å—Ç—å –≤—Ä–∞—á.', 'm2'),
        new ChatMessage('–ì–¥–µ –±–æ–ª–∏—Ç?', 'm3'),
        new ChatMessage('–î–∞–≤–∞–π, –≤–æ–∑–≤—Ä–∞—â–∞–π—Å—è –≤ –±–æ–π.', 'm4'),
        new ChatMessage('–°–∫–≤–µ—Ä–Ω–æ –≤—ã–≥–ª—è–¥–∏—à—å.', 'm5'),
        new ChatMessage('–ù—É–∂–Ω–æ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–µ –º–Ω–µ–Ω–∏–µ?', 'm6'),
        new ChatMessage('–ì–¥–µ —Ç–µ–ø–µ—Ä—å –±–æ–ª–∏—Ç?', 'm7'),
        new ChatMessage('–ö–∞–∫ –≤—ã –æ—Ü–µ–Ω–∏—Ç–µ –±–æ–ª—å –ø–æ –¥–µ—Å—è—Ç–∏–±–∞–ª–ª—å–Ω–æ–π —à–∫–∞–ª–µ?', 'm8'),
        new ChatMessage('–ü—Ä–∏–º–∏ –¥–≤–µ —Ç–∞–±–ª–µ—Ç–∫–∏ –∏ –ø–æ–∑–≤–æ–Ω–∏ –º–Ω–µ —É—Ç—Ä–æ–º.', 'm10'),
        new ChatMessage('–ü–æ–∑–≤–æ–ª—å, —è —Ç–µ–±—è –æ—Å–º–æ—Ç—Ä—é.', 'm11'),
        new ChatMessage('–ü—Ä–æ–≥–Ω–æ–∑ –Ω–µ –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–∏–π.', 'm12'),
        new ChatMessage('–ë–æ—é—Å—å, –≤–∞—à–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–µ –Ω–µ–∏–∑–ª–µ—á–∏–º–æ.', 'm13'),
        new ChatMessage('–î–∞–≤–∞–π —è —Ç–µ–±—è –ø–æ–¥–ª–µ—á—É.', 'm14'),
        new ChatMessage('–†–∞–∑–≤–µ –Ω–∞—Å–∏–ª–∏–µ - —ç—Ç–æ –≤—ã—Ö–æ–¥?', 'm15'),
    ];

    function getDateDiff(day1, day2) {
        let diffTime = Math.abs(day1 - day2);
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }

    function convertTZ(date, tzString) {
        return new Date((typeof date === "string" ? new Date(date) : date).toLocaleString("en-US", {timeZone: tzString}));
    }

    function getCurrentLvl() {
        return parseInt(inputCurrentLvl.val());
    }

    function calculateForNow() {
        let currentDay = new Date();
        currentDay = convertTZ(currentDay, "UTC");

        let daysPassedFromBattlePassStart = getDateDiff(currentDay, convertTZ(battlePassStartDate, "UTC"));
        let daysRemaining = battlePassDuration - daysPassedFromBattlePassStart;
        let expectedLvl = battlePassStartLvl + Math.ceil(lvlsForDay * (battlePassDuration - daysRemaining));

        let currentLevel = getCurrentLvl();
        localStorage.setItem('currentLevel', currentLevel);

        let lvlDiff = getLvlDiff(currentLevel, expectedLvl)
        changeThumbnail(currentLevel, expectedLvl)
        displayTodayStats.html(`<span class="fw-bold">${expectedLvl}</span> ${lvlDiff}`);
        displayDaysRemaining.html(`<span class="fw-bold">${daysRemaining + 1}</span> / <span class="text-muted">${battlePassDuration}</span>`);
        drawTable(currentLevel, lvlDiff, daysPassedFromBattlePassStart);
    }

    function changeThumbnail(currentLevel, expectedLvl) {
        let levelDifference = currentLevel - expectedLvl;
        if (levelDifference >= 0) {
            levelDifference = 'p' + levelDifference;
        } else {
            levelDifference = 'm' + Math.abs(levelDifference)
        }
        chatMessages.forEach(function (chatMessage) {
            if (chatMessage.rank === levelDifference) {
                $('#chatText').html(chatMessage.text);
                $('#chatImage').attr("src", 'img/' + chatMessage.file);
            }
        });
    }

    function getLvlDiff(currentLevel, expectedLevel) {
        let levelDiff = currentLevel - expectedLevel;
        if (levelDiff >= 0) {
            return ` <span class="text-success">+${levelDiff} –æ—Ç —Ü–µ–ª–∏</span>`;
        } else {
            return ` <span class="text-danger">${levelDiff} –æ—Ç —Ü–µ–ª–∏</span>`;
        }
    }

    function incrementDate(date) {
        date.setDate(date.getDate() + 1);
        return date;
    }

    function drawTable(currentLevel, lvlDiff, daysPassedFromBattlePassStart) {
        let date = new Date(battlePassStartDate);
        displayTable.empty();

        for (let index = 1; index <= battlePassDuration; index++) {
            date = incrementDate(date);
            if (index < daysPassedFromBattlePassStart) {
                continue
            }
            let expectedLvl = battlePassStartLvl + Math.ceil(lvlsForDay * index);

            let displayLvlDiff = '';
            if (index === daysPassedFromBattlePassStart || index === 1 && daysPassedFromBattlePassStart === 0) {
                displayLvlDiff = lvlDiff;
            }

            let eventString = ' ';
            events.forEach(function (event) {
                if (date >= event.dateStart && date <= event.dateEnd) {
                    eventString = eventString + ` <span title="${event.name}">${event.emoji}</span>`;
                }
            })

            let row = `<tr><th scope="row">${index}</th><td>${date.toLocaleDateString("ru-RU", {
                day: "numeric",
                month: "numeric",
                year: "numeric",
                hour: "numeric",
                minute: "2-digit"
            }) + eventString}</td><td>${expectedLvl + displayLvlDiff}</td></tr>`

            displayTable.append(row);
        }
    }

    function showTime(previousTime = null) {
        let date = new Date();
        date = convertTZ(date, "UTC");

        if(previousTime) {
            if(date.getTime() - previousTime.getTime() > 1000) {
                calculateForNow();
            }
        }

        let h = 18 - date.getHours(); // 0 - 23
        let m = 59 - date.getMinutes(); // 0 - 59
        let s = 59 - date.getSeconds(); // 0 - 59

        if (h < 0) {
            h = 24 + h;
        }

        if (h === 23 && m === 59 && s === 58) {
            calculateForNow();
        }

        h = (h < 10) ? "0" + h : h;
        m = (m < 10) ? "0" + m : m;
        s = (s < 10) ? "0" + s : s;

        let time = h + ":" + m + ":" + s;
        $('#timeRemaining').html(time);

        setTimeout(showTime, 1000, date);
    }

    function init() {
        savedCurrentLevel = localStorage.getItem('currentLevel');
        if (savedCurrentLevel > 0) {
            inputCurrentLvl.val(savedCurrentLevel);
        }

        calculateForNow();
        showTime();

    }

    function changeCurrentLvl(number) {
        let currentLvl = getCurrentLvl();
        currentLvl = currentLvl + number;
        inputCurrentLvl.val(currentLvl);
        calculateForNow();
    }

    init();

    inputCurrentLvl.on('change', function () {
        calculateForNow();
    })

    decrementButton.on('click', function () {
        changeCurrentLvl(-1);
    })

    incrementButton.on('click', function () {
        changeCurrentLvl(1);
    })

    $('#unlockEdit').on('click', function () {
        if (inputCurrentLvl.prop('disabled')) {
            $('#lockIcon').attr('class', 'bi bi-unlock-fill');
            $('#currentLevel').prop('disabled', false);
        } else {
            $('#lockIcon').attr('class', 'bi bi-lock-fill');
            $('#currentLevel').prop('disabled', true);
        }
    })
</script>
</body>
</html>