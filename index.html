<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Overcalc</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">
</head>
<body>
<div class="container">
    <div class="row justify-content-md-center">
        <div class="col-lg-6 col-sm-12 col-md-8">
            <h1 class="pt-3">Overcalc</h1>
            <form>
                <div class="row">
                    <div class="col-md-3 col-sm-6">
                        <label>–î–Ω–µ–π –æ—Å—Ç–∞–ª–æ—Å—å:</label>
                        <div class="form-control-plaintext form-control-lg mb-3" id="daysRemaining"></div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <label>–¶–µ–ª—å —Å–µ–≥–æ–¥–Ω—è:</label>
                        <div class="form-control-plaintext form-control-lg mb-3" id="todayStats"></div>
                    </div>
                    <div class="col-md-6 col-sm-12">
                        <label>–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å:</label>
                        <div class="mb-3 d-flex flex-row">
                            <div class="input-group me-2">
                                <button class="btn btn-outline-secondary" type="button" id="unlockEdit"><i id="lockIcon" class="bi bi-lock-fill"></i></button>
                                <input class="form-control form-control-lg" id="currentLevel" type="number" placeholder="–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å" value="0" disabled>
                            </div>
                            <button id="decrementCurrentLevel" class="btn btn-outline-primary" type="button"><i class="bi bi-dash-lg"></i></button>
                            <button id="incrementCurrentLevel" class="btn btn-outline-primary ms-2" type="button"><i class="bi bi-plus-lg"></i></button>
                        </div>
                    </div>
                    
                </div>

            </form>
            <div class="pt-3">
                <h2>–î–Ω–∏ —Ñ–∞—Ä–º–∞</h2>
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th scope="col">–î–µ–Ω—å</th>
                        <th scope="col">–î–∞—Ç–∞</th>
                        <th scope="col">–£—Ä–æ–≤–µ–Ω—å</th>
                    </tr>
                    </thead>
                    <tbody id="daysList">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.6.1.min.js"
        integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>

<script>
    class Event {
        constructor(name, dateStart, dateEnd, emoji) {
            this.name = name;
            this.dateStart = new Date(dateStart);
            this.dateEnd = new Date(dateEnd);
            this.emoji = emoji;
        }
    }

    const startLevel = 1;
    const endLevel = 200;
    let currentDay = new Date('12/06/2022');
    const startDay = new Date('12/06/2022');
    const endDay = new Date('02/07/2023');
    const diffTime = Math.abs(endDay - startDay);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    let diffTimeFromNow = Math.abs(currentDay - startDay);
    let diffDaysFromNow = Math.ceil(diffTimeFromNow / (1000 * 60 * 60 * 24));
    let daysRemains = Math.abs(endDay - currentDay);
    let daysRemainsDiff = Math.ceil(daysRemains / (1000 * 60 * 60 * 24));
    $('#daysRemaining').html('<span class="fw-bold">' +daysRemainsDiff + '</span> / <span class="text-muted">' + diffDays + '</span>');
    const winterWonderland = new Event("–ó–∏–º–Ω—è—è –°–∫–∞–∑–∫–∞", "12/13/2022", "01/04/2023", "‚ùÑ");
    const BattleForOlympus = new Event("–ë–∏—Ç–≤–∞ –∑–∞ –û–ª–∏–º–ø", "01/05/2023", "01/19/2023", "üèÜ");
    const LunarNewYear = new Event("–õ—É–Ω–Ω—ã–π –ù–æ–≤—ã–π –ì–æ–¥", "01/17/2023", "02/06/2023", "üê∞");
    const events = [winterWonderland, BattleForOlympus, LunarNewYear];

    function calculateDays() {
        let date = new Date(startDay);
        $('#daysList').empty();
        let currentLevel = parseInt($('#currentLevel').val());
        localStorage.setItem('currentLevel', currentLevel);

        let levelsForDay = (endLevel - startLevel) / diffDays;
        for (let index = 1; index <= diffDays; index++) {
            expectedLevel = startLevel + Math.ceil(levelsForDay * index);
            if (index === diffDaysFromNow || index === 1 && diffDaysFromNow === 0) {
                levelDiff = currentLevel - expectedLevel;
                if (levelDiff >= 0) {
                    levelDiffText = '<span class="text-success">+' + levelDiff + ' –æ—Ç —Ü–µ–ª–∏</span>';
                } else {
                    levelDiffText = '<span class="text-danger">' + levelDiff + ' –æ—Ç —Ü–µ–ª–∏</span>';
                }
                expectedLevel = expectedLevel + ' <b>' + levelDiffText + '</b>';
                let expected = startLevel + Math.ceil(levelsForDay * index);
                let diff
                $('#todayStats').html('<span class="fw-bold">'+expected+'</span> '+levelDiffText+'');
            }
            let eventString = ' ';
            events.forEach(function (event){
                if (date >= event.dateStart && date <= event.dateEnd) {
                    eventString = eventString + ' <span title="'+event.name+'">' + event.emoji + '</>';
                }
            })
            let row = '<tr><th scope="row">' + index + '</th><td>' + date.toLocaleDateString() + eventString + '</td><td>' + expectedLevel + '</td></tr>'
            date.setDate(date.getDate() + 1)
            if (index >= diffDaysFromNow) {
                $('#daysList').append(row);
            }
        }
    }

    savedCurrentLevel = localStorage.getItem('currentLevel');
    if (savedCurrentLevel > 0) {
        $('#currentLevel').val(savedCurrentLevel);
    }

    calculateDays();

    setInterval(function() {
        currentDay = Date.now();
        diffTimeFromNow = Math.abs(currentDay - startDay);
        diffDaysFromNow = Math.ceil(diffTimeFromNow / (1000 * 60 * 60 * 24));
        daysRemains = Math.abs(endDay - currentDay);
        daysRemainsDiff = Math.ceil(daysRemains / (1000 * 60 * 60 * 24));
        $('#daysRemaining').html('<span class="fw-bold">' +daysRemainsDiff + '</span> / <span class="text-muted">' + diffDays + '</span>');
        calculateDays();
    }, 60 * 1000); // 60 * 1000 milsec
    
    $('#currentLevel').on('change', function () {
        calculateDays();
    })

    $('#decrementCurrentLevel').on('click', function () {
        let currentLevel = parseInt($('#currentLevel').val());
        currentLevel--;
        $('#currentLevel').val(currentLevel);
        calculateDays();
    })
    $('#incrementCurrentLevel').on('click', function () {
        let currentLevel = parseInt($('#currentLevel').val());
        currentLevel++;
        $('#currentLevel').val(currentLevel);
        calculateDays();
    })

    $('#unlockEdit').on('click', function () {
        console.log($('#currentLevel').prop('disabled'));
        if ($('#currentLevel').prop('disabled')) {
            $('#lockIcon').attr('class', 'bi bi-unlock-fill');
            $('#currentLevel').prop('disabled', false);
        } else {
            $('#lockIcon').attr('class', 'bi bi-lock-fill');
            $('#currentLevel').prop('disabled', true);
        }
    })
</script>
</body>
</html>